{% extends "base.html" %}

{% block title %}Learning Cards - VibeCode{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if cards %}
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>üìö {{ desk.name_en }}</h1>
            <p class="text-muted">{{ cards | length }} cards</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('cards.play') }}" class="btn btn-outline-secondary">‚Üê Back</a>
        </div>
    </div>

    <!-- Flip Card Container -->
    <div style="perspective: 1000px; max-width: 500px; margin: 40px auto;">
        <div id="flip-card" style="position: relative; width: 100%; height: 350px; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; user-select: none;" onclick="flipCard.style.transform = flipCard.style.transform === 'rotateY(180deg)' ? '' : 'rotateY(180deg)'; if (flipCard.style.transform === 'rotateY(180deg)') { markCompleted(); }">            
            <!-- Front Face -->
            <div id="front" style="position: absolute; inset: 0; border: 2px solid #ccc; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; color: white; text-align: center;">
                <img id="front-img" src="" alt="card" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; display: none;">
            </div>
            
            <!-- Back Face -->
            <div id="back" style="position: absolute; inset: 0; border: 2px solid #ccc; border-radius: 12px; background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); padding: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; backface-visibility: hidden; transform: rotateY(180deg); color: white; text-align: center;">
                <h3 id="back-question" style="font-size: 32px; font-weight: bold; margin-bottom: 8px; color: #ffffffff;"></h3>
                <p id="back-pronunciation" style="font-size: 20px; color: #d0d0d0; font-style: italic; margin: 8px 0 0 0;"></p>
                <h2 id="back-answer" style="font-size: 20px; font-weight: bold; margin-bottom: 12px;"></h2>
                <p id="back-example" style="font-size: 13px; color: #c0c0c0; font-style: italic; margin: 12px 0 0 0;"></p>
                
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div style="text-align: center; margin-top: 30px;">
        <button onclick="prevCard()" class="btn btn-outline-secondary me-2">‚üµ Prev</button>
        <span id="counter" style="margin: 0 20px; font-weight: bold;">0 / 0</span>
        <button onclick="nextCard()" class="btn btn-outline-secondary ms-2">Next ‚ü∂</button>
    </div>

    <!-- Card Numbers -->
    <div id="nav-nums" style="text-align: center; margin-top: 20px;"></div>

    {% else %}
    <div class="alert alert-warning">
        <h4>No cards found!</h4>
        <p>Please select a desk with cards.</p>
    </div>
    {% endif %}
</div>

<script>
// Data from template
const cardsData = {{ cards_json_data | tojson | safe }};
const completedIds = {{ completed_ids | tojson | safe }};
const dueIds = {{ due_ids | tojson | safe }};

console.log('Cards Data:', cardsData);
console.log('Completed IDs:', completedIds);
console.log('Due IDs:', dueIds);

let currentIndex = 0;
const flipCard = document.getElementById('flip-card');
const frontImg = document.getElementById('front-img');
const backQuestion = document.getElementById('back-question');
const backAnswer = document.getElementById('back-answer');
const counter = document.getElementById('counter');
const navNums = document.getElementById('nav-nums');

function renderCard() {
    if (cardsData.length === 0) return;
    
    const card = cardsData[currentIndex];
    console.log('Current card:', card);
    
    const front = document.getElementById('front');
    
    // Map color names to hex colors
    const colorMap = {
        'Red': '#FF0000',
        'Blue': '#0000FF',
        'Green': '#00AA00',
        'Yellow': '#FFFF00',
        'Purple': '#800080',
        'Pink': '#FFC0CB',
        'Black': '#000000',
        'White': '#FFFFFF',
        'Brown': '#8B4513',
        'Orange': '#FFA500'
    };
    
    // Check if this is a color card
    const isColor = colorMap[card.question] !== undefined;
    
    // Front - show image or color
    if (isColor) {
        // For colors, show ONLY colored background, no image
        frontImg.style.display = 'none';
        const color = colorMap[card.question];
        front.style.background = color;
        front.style.color = (card.question === 'White' || card.question === 'Yellow') ? '#000' : '#fff';
    } else if (card.img && card.img.startsWith('http')) {
        // For regular items, show image
        frontImg.src = card.img;
        frontImg.style.display = 'block';
        front.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        front.style.color = 'white';
    } else {
        // No image available
        frontImg.style.display = 'none';
        front.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        front.style.color = 'white';
    }
    
    // Back - show text with pronunciation
    const backQuestion = document.getElementById('back-question');
    backQuestion.textContent = card.question;
    backAnswer.textContent = card.answer;
    
    // Hi·ªÉn th·ªã pronunciation
    const backPronunciation = document.getElementById('back-pronunciation');
    if (card.pronunciation && card.pronunciation.trim()) {
        backPronunciation.textContent = card.pronunciation;
        backPronunciation.style.display = 'block';
    } else {
        backPronunciation.style.display = 'none';
    }
    
    // Hi·ªÉn th·ªã example (n·∫øu kh√¥ng ph·∫£i URL h√¨nh ·∫£nh)
    const backExample = document.getElementById('back-example');
    if (card.example && card.example.trim() && !card.example.startsWith('http')) {
        backExample.textContent = 'üìù ' + card.example;
        backExample.style.display = 'block';
    } else {
        backExample.style.display = 'none';
    }
    
    // Counter
    counter.textContent = (currentIndex + 1) + ' / ' + cardsData.length;
    
    // Reset flip
    flipCard.style.transform = '';
    
    // Render nav numbers
    renderNav();
}

function renderNav() {
    navNums.innerHTML = '';
    for (let i = 0; i < cardsData.length; i++) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm me-2 ' + (i === currentIndex ? 'btn-primary' : 'btn-outline-secondary');
        btn.textContent = (i + 1);
        btn.onclick = () => {
            currentIndex = i;
            renderCard();
        };
        navNums.appendChild(btn);
    }
}

function prevCard() {
    currentIndex = (currentIndex - 1 + cardsData.length) % cardsData.length;
    renderCard();
}

function markCompleted() {
    const card = cardsData[currentIndex];
    if (!card) return;
    
    // Send to backend
    fetch('{{ url_for("cards.review_card") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            card_id: card.id,
            is_correct: true
        })
    }).then(response => {
        console.log('Card marked as completed:', card.id, response.status);
    }).catch(err => {
        console.error('Error marking card:', err);
    });
}

function nextCard() {
    currentIndex = (currentIndex + 1) % cardsData.length;
    renderCard();
}

// Initialize
renderCard();
</script>

{% endblock %}
